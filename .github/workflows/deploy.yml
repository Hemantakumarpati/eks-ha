name: Deploy Production EKS (HA)
on:
  workflow_dispatch: # Allows manual trigger

permissions:
  id-token: write # Required for OIDC
  contents: read

env:
  AWS_REGION: ap-south-1
  STACK_NAME: production-eks-ha

jobs:
  deploy-infrastructure:
    name: Deploy EKS Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation Templates
        run: |
          aws cloudformation validate-template --template-body file://templates/master.yaml

      - name: Run Deployment Script
        run: |
          chmod +x deploy.sh
          ./deploy.sh ${{ secrets.S3_BUCKET }} ${{ env.STACK_NAME }} ${{ secrets.AWS_CONNECTION_ARN }} ${{ github.repository }}

      - name: Post-Deployment Check
        if: always()
        run: |
          echo "Checking CloudFormation Stack Status in ap-south-1:"
          STATUS=$(aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} --query "Stacks[0].StackStatus" --output text || echo "NOT_FOUND")
          echo "Current Status: $STATUS"
          
          if [[ "$STATUS" == *"ROLLBACK"* ]]; then
            echo "::error::Stack is in $STATUS state. Fetching failure events..."
            aws cloudformation describe-stack-events --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED`].{Resource:LogicalResourceId,Status:ResourceStatus,Reason:ResourceStatusReason}' --output table
          fi
          
          if [ "$STATUS" == "CREATE_COMPLETE" ] || [ "$STATUS" == "UPDATE_COMPLETE" ]; then
            echo "Listing EKS Clusters in ap-south-1:"
            aws eks list-clusters --region ${{ env.AWS_REGION }}
            
            echo "Checking Stack Outputs:"
            aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }} --query "Stacks[0].Outputs"
            
            aws eks update-kubeconfig --name ${{ env.STACK_NAME }} --region ${{ env.AWS_REGION }}
            kubectl get nodes -o wide
          else
            echo "Skipping EKS checks as stack is in failed/incomplete state: $STATUS"
            exit 1
          fi
